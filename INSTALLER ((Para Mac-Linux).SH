#!/bin/bash

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funci√≥n para imprimir con colores
print_message() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

clear
echo "========================================"
echo "   LINKEDIN ASSISTANT - INSTALADOR"
echo "========================================"
echo ""
echo "üöÄ Este instalador configurar√° todo autom√°ticamente"
echo "üì¶ Se instalar√°n: Python, dependencias y estructura"
echo ""
echo "‚ö†Ô∏è  Aseg√∫rate de tener:"
echo "   ‚Ä¢ MacOS 10.15+ o Linux Ubuntu/Debian"
echo "   ‚Ä¢ Conexi√≥n a Internet activa"
echo "   ‚Ä¢ Permisos de administrador (sudo)"
echo ""

# Verificar si es Mac o Linux
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="MAC"
    print_message "Sistema detectado: macOS"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="LINUX"
    print_message "Sistema detectado: Linux"
else
    print_error "Sistema operativo no compatible"
    exit 1
fi

# Verificar Python
print_message "Verificando Python..."
if ! command -v python3 &> /dev/null; then
    print_warning "Python3 no est√° instalado"
    
    if [ "$OS" = "MAC" ]; then
        print_message "Instalando Python con Homebrew..."
        if ! command -v brew &> /dev/null; then
            print_message "Instalando Homebrew primero..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        brew install python@3.9
    elif [ "$OS" = "LINUX" ]; then
        print_message "Instalando Python con apt..."
        sudo apt update
        sudo apt install -y python3 python3-venv python3-pip
    fi
    
    if ! command -v python3 &> /dev/null; then
        print_error "No se pudo instalar Python"
        print_message "Por favor, instala Python manualmente:"
        print_message "https://www.python.org/downloads/"
        exit 1
    fi
fi

PYTHON_VERSION=$(python3 --version)
print_success "Python detectado: $PYTHON_VERSION"

# Crear carpeta del proyecto
print_message "Creando estructura de carpetas..."
mkdir -p linkedin_assistant
cd linkedin_assistant || exit 1

mkdir -p exports logs backups session static templates

print_success "Carpetas creadas"

# Crear entorno virtual
print_message "Creando entorno virtual Python..."
python3 -m venv venv
if [ $? -ne 0 ]; then
    print_error "Error creando entorno virtual"
    exit 1
fi

print_success "Entorno virtual creado"

# Activar entorno e instalar dependencias
print_message "Instalando dependencias..."
source venv/bin/activate

pip install --upgrade pip
pip install selenium==4.15.2 flask==3.0.0 pyyaml==6.0.1

print_success "Dependencias instaladas"

# Crear archivos de configuraci√≥n
print_message "Creando archivos de configuraci√≥n..."

# Crear config.yaml b√°sico
cat > config.yaml << 'EOF'
# üõ°Ô∏è CONFIGURACI√ìN DE LINKEDIN ASSISTANT

linkedin:
  email: "TU_EMAIL_AQUI@ejemplo.com"
  password: "TU_CONTRASE√ëA_AQUI"

limits:
  daily_connections: 25
  weekly_connections: 100
  connections_per_hour: 8
  messages_per_day: 40
  min_action_delay: 12
  max_action_delay: 30

search:
  keywords: "CEO Founder Director"
  locations: "Espa√±a"
  industries: "Tecnolog√≠a"

messages:
  connection_request:
    - template: "Hola {{first_name}}, vi tu perfil y me gustar√≠a conectar."

behavior:
  work_schedule:
    monday: ["09:00", "18:00"]
    tuesday: ["09:00", "18:00"]
    wednesday: ["09:00", "18:00"]
    thursday: ["09:00", "18:00"]
    friday: ["09:00", "16:00"]
    saturday: []
    sunday: []
EOF

print_success "config.yaml creado"

# Crear archivos Python principales (simplificados)
cat > linkedin_bot.py << 'EOF'
import time
import random
import yaml

print("LinkedIn Bot - Instalaci√≥n completada")
print("Por favor, configura tu config.yaml primero")
EOF

cat > app.py << 'EOF'
from flask import Flask

app = Flask(__name__)

@app.route('/')
def home():
    return "LinkedIn Assistant - Instalaci√≥n completada"

if __name__ == "__main__":
    app.run(debug=True)
EOF

# Crear scripts de inicio
print_message "Creando scripts de inicio..."

# Crear inicio.sh
cat > inicio.sh << 'EOF'
#!/bin/bash

clear
echo "========================================"
echo "   LINKEDIN ASSISTANT - INICIANDO"
echo "========================================"
echo ""

# Verificar ChromeDriver
if [ ! -f "chromedriver" ] && [ ! -f "chromedriver.exe" ]; then
    echo "‚ùå ERROR: No se encontr√≥ chromedriver"
    echo ""
    echo "üì• Para solucionarlo:"
    echo "1. Ve a https://chromedriver.chromium.org/"
    echo "2. Descarga la versi√≥n compatible con tu Chrome"
    echo "3. Guarda el archivo como 'chromedriver' aqu√≠"
    echo ""
    echo "üîç Para ver tu versi√≥n de Chrome:"
    echo "   ‚Ä¢ Abre Chrome"
    echo "   ‚Ä¢ Haz clic en los 3 puntos ‚Üí Ayuda ‚Üí Acerca de Google Chrome"
    echo ""
    exit 1
fi

# Verificar config.yaml
if [ ! -f "config.yaml" ]; then
    echo "‚ùå ERROR: No se encontr√≥ config.yaml"
    echo "Crea el archivo de configuraci√≥n primero"
    exit 1
fi

# Dar permisos de ejecuci√≥n a chromedriver
if [ -f "chromedriver" ]; then
    chmod +x chromedriver
fi

# Activar entorno virtual
source venv/bin/activate

# Iniciar aplicaci√≥n
python3 app.py
EOF

chmod +x inicio.sh

# Crear configurar.sh
cat > configurar.sh << 'EOF'
#!/bin/bash

clear
echo "========================================"
echo "    CONFIGURACI√ìN PASO A PASO"
echo "========================================"
echo ""
echo "üìù Vamos a configurar tu LinkedIn Assistant:"
echo ""

# 1. ChromeDriver
if [ ! -f "chromedriver" ] && [ ! -f "chromedriver.exe" ]; then
    echo "üîß PASO 1: Instalar ChromeDriver"
    echo ""
    echo "1. Abre Google Chrome"
    echo "2. Haz clic en los 3 puntos (arriba derecha)"
    echo "3. Ve a 'Ayuda' ‚Üí 'Acerca de Google Chrome'"
    echo "4. Anota el n√∫mero de versi√≥n (ej: 120.0.6099.130)"
    echo ""
    echo "‚è≥ Abriendo navegador para descargar..."
    
    if [[ "$OSTYPE" == "darwin"* ]]; then
        open "https://chromedriver.chromium.org/"
    else
        xdg-open "https://chromedriver.chromium.org/"
    fi
    
    echo ""
    echo "üì• Descarga la versi√≥n que coincida con tu Chrome"
    echo "üí° Ejemplo: Si tienes Chrome 120, descarga ChromeDriver 120.x.x.x"
    echo ""
    read -p "Presiona Enter cuando hayas descargado ChromeDriver..."
else
    echo "‚úÖ ChromeDriver ya instalado"
fi

# 2. Configuraci√≥n b√°sica
echo ""
echo "üîß PASO 2: Configurar credenciales"
echo ""
echo "Abriendo config.yaml para editar..."

sleep 2

if [ ! -f "config.yaml" ]; then
    echo "‚ùå config.yaml no encontrado"
    exit 1
fi

# Abrir con editor
if command -v nano &> /dev/null; then
    nano config.yaml
elif command -v vim &> /dev/null; then
    vim config.yaml
else
    echo "üí° INSTRUCCIONES:"
    echo "1. Abre config.yaml con tu editor de texto favorito"
    echo "2. Cambia TU_EMAIL_AQUI@ejemplo.com por tu email real"
    echo "3. Cambia TU_CONTRASE√ëA_AQUI por tu contrase√±a real"
    echo "4. Ajusta keywords, locations, industries a tu nicho"
    echo "5. Guarda el archivo"
    echo ""
    read -p "Presiona Enter cuando hayas editado el archivo..."
fi

echo ""
echo "‚úÖ Configuraci√≥n completada"
echo ""
echo "üöÄ Ahora puedes ejecutar ./inicio.sh para comenzar"
EOF

chmod +x configurar.sh

# Crear actualizar.sh
cat > actualizar.sh << 'EOF'
#!/bin/bash

clear
echo "========================================"
echo "   ACTUALIZANDO LINKEDIN ASSISTANT"
echo "========================================"
echo ""

# Activar entorno virtual
source venv/bin/activate

# Actualizar dependencias
echo "üì¶ Actualizando Python packages..."
pip install --upgrade selenium flask pyyaml

# Verificar ChromeDriver
echo "üîç Verificando versi√≥n de ChromeDriver..."
if [ -f "chromedriver" ] || [ -f "chromedriver.exe" ]; then
    echo "‚úÖ ChromeDriver encontrado"
    echo "üí° Recuerda actualizarlo si actualizas Chrome"
else
    echo "‚ö†Ô∏è  ChromeDriver no encontrado"
    echo "Ejecuta ./configurar.sh primero"
fi

echo ""
echo "‚úÖ Actualizaci√≥n completada"
EOF

chmod +x actualizar.sh

# Crear README
cat > README.txt << 'EOF'
========================================
     LINKEDIN ASSISTANT - GU√çA R√ÅPIDA
========================================

üéØ OBJETIVO: Conectar con 25-30 personas/d√≠a
            de forma segura y autom√°tica

üìÅ ARCHIVOS IMPORTANTES:
‚Ä¢ config.yaml - Tu configuraci√≥n (EDITAR ESTE)
‚Ä¢ inicio.sh - Para iniciar el programa
‚Ä¢ configurar.sh - Para configurar paso a paso
‚Ä¢ actualizar.sh - Para actualizar dependencias

üöÄ C√ìMO COMENZAR (3 PASOS):

1. EJECUTA ./configurar.sh
   Te guiar√° para instalar ChromeDriver
   y configurar tus credenciales

2. EDITA config.yaml
   ‚Ä¢ Cambia email y contrase√±a
   ‚Ä¢ Ajusta keywords a tu nicho
   ‚Ä¢ Configura l√≠mites seguros

3. EJECUTA ./inicio.sh
   Se abrir√° una ventana web en tu navegador
   Usa los botones para controlar el bot

‚ö†Ô∏è  CONSEJOS DE SEGURIDAD:
‚Ä¢ Nunca superes 25 conexiones/d√≠a
‚Ä¢ Usa horarios laborales reales
‚Ä¢ Personaliza los mensajes
‚Ä¢ Haz backup regular de exports/

‚ùì PROBLEMAS COMUNES:

1. "chromedriver: command not found"
   Soluci√≥n: Ejecuta ./configurar.sh

2. "Error de login"
   Soluci√≥n: Verifica email/contrase√±a en config.yaml

3. "LinkedIn pide verificaci√≥n"
   Soluci√≥n: Espera 24 horas, reduce l√≠mites

üìû SOPORTE:
Guarda los archivos de logs/ si necesitas ayuda

========================================
        ¬°√âXITO CON TU PROSPECCI√ìN!
========================================
EOF

# Intentar detectar y descargar ChromeDriver autom√°ticamente
print_message "Intentando detectar Chrome..."
if [ "$OS" = "MAC" ]; then
    CHROME_PATH="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
    if [ -f "$CHROME_PATH" ]; then
        CHROME_VERSION=$("$CHROME_PATH" --version | awk '{print $3}')
    fi
elif [ "$OS" = "LINUX" ]; then
    if command -v google-chrome &> /dev/null; then
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
    elif command -v chromium-browser &> /dev/null; then
        CHROME_VERSION=$(chromium-browser --version | awk '{print $2}')
    fi
fi

if [ ! -z "$CHROME_VERSION" ]; then
    MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
    print_success "Chrome detectado: Versi√≥n $CHROME_VERSION"
    
    print_message "Intentando descargar ChromeDriver autom√°ticamente..."
    
    # Descargar ChromeDriver
    if [ "$OS" = "MAC" ]; then
        ARCH="mac64"
    elif [ "$OS" = "LINUX" ]; then
        ARCH="linux64"
    fi
    
    VERSION_URL="https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$MAJOR_VERSION"
    LATEST_VERSION=$(curl -s $VERSION_URL)
    
    if [ ! -z "$LATEST_VERSION" ]; then
        DOWNLOAD_URL="https://chromedriver.storage.googleapis.com/$LATEST_VERSION/chromedriver_$ARCH.zip"
        
        curl -L -o chromedriver.zip $DOWNLOAD_URL
        if [ $? -eq 0 ]; then
            unzip -o chromedriver.zip
            rm chromedriver.zip
            chmod +x chromedriver
            print_success "ChromeDriver descargado autom√°ticamente"
        else
            print_warning "No se pudo descargar autom√°ticamente"
            print_message "Descarga manual desde: https://chromedriver.chromium.org/"
        fi
    else
        print_warning "No se pudo obtener versi√≥n de ChromeDriver"
        print_message "Descarga manual desde: https://chromedriver.chromium.org/"
    fi
else
    print_warning "Chrome no detectado o no est√° instalado"
    print_message "Descarga manual desde: https://chromedriver.chromium.org/"
fi

print_success "Instalaci√≥n completada"
echo ""
echo "========================================"
echo "        üéâ INSTALACI√ìN COMPLETADA"
echo "========================================"
echo ""
echo "‚úÖ TODO LISTO"
echo ""
echo "üìù AHORA NECESITAS:"
echo "1. Ejecutar ./configurar.sh (para configuraci√≥n guiada)"
echo "   O"
echo "2. Editar manualmente config.yaml con tus datos"
echo ""
echo "üöÄ LUEGO EJECUTA:"
echo "./inicio.sh - Para iniciar el programa"
echo ""
echo "üìÅ EN ESTA CARPETA ENCONTRAR√ÅS:"
echo "‚Ä¢ config.yaml - Configuraci√≥n (¬°EDITA ESTE!)"
echo "‚Ä¢ inicio.sh - Para iniciar"
echo "‚Ä¢ configurar.sh - Configuraci√≥n guiada"
echo "‚Ä¢ actualizar.sh - Para actualizar"
echo "‚Ä¢ README.txt - Esta gu√≠a"
echo ""
echo "üí° CONSEJO: Mant√©n esta carpeta en un lugar seguro"
echo ""
echo "========================================"
EOF

print_success "Instalador creado exitosamente"

# Dar permisos de ejecuci√≥n
chmod +x installer.sh

echo ""
print_message "Para instalar, ejecuta:"
echo "1. ./installer.sh  (en Mac/Linux)"
echo "2. Doble clic en installer.bat  (en Windows)"
echo ""
print_message "¬°Listo para comenzar! üöÄ"